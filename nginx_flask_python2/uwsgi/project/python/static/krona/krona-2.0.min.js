function resize(){if(imageWidth=window.innerWidth,imageHeight=window.innerHeight,snapshotMode||(context.canvas.width=imageWidth,context.canvas.height=imageHeight),datasetDropDown){var e=2*(datasetDropDown.offsetTop+datasetDropDown.clientHeight)/imageHeight;e>1&&(e=1),e=Math.sqrt(e),datasetSelectWidth=(datasetDropDown.offsetLeft+datasetDropDown.clientWidth)*e}var t=datasets>1?datasetSelectWidth+30:0,a=imageWidth-mapWidth-t>imageHeight?imageHeight:imageWidth-mapWidth-t;maxMapRadius=.03*a,buffer=a*bufferFactor,margin=.015*a,centerX=(imageWidth-mapWidth-t)/2+t,centerY=imageHeight/2,gRadius=a/2-buffer}function handleResize(){updateViewNeeded=!0}function Attribute(){}function Tween(e,t){this.start=e,this.end=t,this.current=this.start,this.current=function(){return 1==progress||this.start==this.end?this.end:this.start+tweenFactor*(this.end-this.start)},this.setTarget=function(e){this.start=this.current(),this.end=e}}function Node(){this.id=currentNodeID,currentNodeID++,nodes[this.id]=this,this.angleStart=new Tween(Math.PI,0),this.angleEnd=new Tween(Math.PI,0),this.radiusInner=new Tween(1,1),this.labelRadius=new Tween(1,1),this.labelWidth=new Tween(0,0),this.scale=new Tween(1,1),this.radiusOuter=new Tween(1,1),this.r=new Tween(255,255),this.g=new Tween(255,255),this.b=new Tween(255,255),this.alphaLabel=new Tween(0,1),this.alphaLine=new Tween(0,1),this.alphaArc=new Tween(0,0),this.alphaWedge=new Tween(0,1),this.alphaOther=new Tween(0,1),this.alphaPattern=new Tween(0,0),this.children=Array(),this.parent=0,this.attributes=new Array(attributes.length),this.addChild=function(e){this.children.push(e)},this.addLabelNode=function(e,t){0==labelHeadNodes[e][t]&&(labelHeadNodes[e][t]=this,this.labelPrev=this);var a=labelHeadNodes[e][t];this.labelNext=a,this.labelPrev=a.labelPrev,a.labelPrev.labelNext=this,a.labelPrev=this},this.canDisplayDepth=function(){return this.depth<=maxAbsoluteDepth},this.canDisplayHistory=function(){var e;return e=compress?compressedRadii[0]:nodeRadius,-this.labelRadius.end*gRadius+historySpacingFactor*fontSize/2<e*gRadius},this.canDisplayLabelCurrent=function(){return(this.angleEnd.current()-this.angleStart.current())*(this.radiusInner.current()*gRadius+gRadius)>=minWidth()},this.checkHighlight=function(){if(0==this.children.length&&this==focusNode,this.hide)return!1;if(1==this.radiusInner.end)return!1;for(var e=!1,t=this.angleStart.current()+rotationOffset,a=this.angleEnd.current()+rotationOffset,i=this.radiusInner.current()*gRadius,s=0;s<this.children.length;s++)if(e=this.children[s].checkHighlight())return!0;return this==selectedNode||this.getCollapse()||(context.beginPath(),context.arc(0,0,i,t,a,!1),context.arc(0,0,gRadius,a,t,!0),context.closePath(),context.isPointInPath(mouseX-centerX,mouseY-centerY)&&(e=!0),!e&&(a-t)*(i+gRadius)<minWidth()&&this.getDepth()==selectedNode.getDepth()+1&&showKeys&&this.checkHighlightKey()&&(e=!0)),e&&(highlightedNode=this),e},this.checkHighlightCenter=function(){if(this.canDisplayHistory()){var e=centerX,t=centerY-this.labelRadius.end*gRadius,a=this.nameWidth;if(this.searchResultChildren()){var i=searchResultString(this.searchResultChildren()),s=context.measureText(i);a+=s.width}return mouseX>e-a/2&&e+a/2>mouseX&&mouseY>t-historySpacingFactor*fontSize/2&&t+historySpacingFactor*fontSize/2>mouseY?void(highlightedNode=this):void(this.getParent()&&this.getParent().checkHighlightCenter())}},this.checkHighlightKey=function(){var e=keyOffset(),t=imageWidth-keySize-margin-this.keyNameWidth-keyBuffer,a=imageWidth-margin,i=e,s=e+keySize;return currentKey++,mouseX>t&&a>mouseX&&mouseY>i&&s>mouseY},this.checkHighlightMap=function(){if(this.parent&&this.parent.checkHighlightMap(),!this.getCollapse()&&this!=focusNode){var e=this.getMapPosition();mouseX>e.x-mapRadius&&mouseX<e.x+mapRadius&&mouseY>e.y-mapRadius&&mouseY<e.y+mapRadius&&(highlightedNode=this)}},this.draw=function(e,t,a){var i=this.getDepth()-selectedNode.getDepth()+1;selectedNode==this&&(t=!0);var s,n=this.angleStart.current()+rotationOffset,o=this.angleEnd.current()+rotationOffset,r=this.radiusInner.current()*gRadius,h=(this.canDisplayLabelCurrent(),!1),d=(!this.hide||!this.hidePrev&&1>progress)&&(!this.hideAlone||!this.hideAlonePrev&&1>progress);if(this.hasChildren()&&(s=this.children[this.children.length-1].angleEnd.current()+rotationOffset),e){var l=!(this.parent&&this.parent!=selectedNode&&o==this.parent.angleEnd.current()+rotationOffset);n!=o&&this.drawLines(n,o,r,l,t);var c,u=this.alphaOther.current();if((this==selectedNode||u)&&(c=this.children[this.children.length-1].radiusInner.current()*gRadius),this==selectedNode&&this.drawReferenceRings(c),t&&!a&&this!=selectedNode&&(this.isSearchResult||this.hideAlone&&this.searchResultChildren())){if(context.globalAlpha=this.alphaWedge.current(),drawWedge(n,o,r,gRadius,highlightFill,0,!0),this.keyed&&!showKeys&&this.searchResults&&!a&&this!=highlightedNode&&this!=focusNode){var g=(o+n)/2;this.drawLabel(g,!0,!1,!0,!0)}a=!0}(this==selectedNode||this!=highlightedNode&&this!=focusNode)&&(context.globalAlpha=this.radial!=this.radialPrev&&1==this.alphaLabel.end?tweenFactor:this.alphaLabel.current(),this.drawLabel((n+o)/2,this.hideAlone&&this.searchResultChildren()||(this.isSearchResult||h)&&t,this==selectedNode&&!this.radial,t,this.radial),this.radial!=this.radialPrev&&1==this.alphaLabel.start&&1>progress&&(context.globalAlpha=1-tweenFactor,this.drawLabel((n+o)/2,(this.isSearchResult||h)&&t,this==selectedNodeLast&&!this.radialPrev,t,this.radialPrev))),u&&null!=s&&(o-s)*(c+gRadius)>=minWidth()&&(context.globalAlpha=this.alphaOther.current(),drawTextPolar(this.getUnclassifiedText(),this.getUnclassifiedPercentage(),(s+o)/2,(c+gRadius)/2,!0,!1,!1,0,0)),this==selectedNode&&this.keyUnclassified&&showKeys&&this.drawKey((s+o)/2,!1,!1)}else{var p=this.alphaWedge.current();if(p||this.alphaOther.current()){var f,m=this.r.current(),b=this.g.current(),x=this.b.current(),y=rgbText(m,b,x),v=this.hasChildren()&&!this.keyed&&(compress||maxDisplayDepth>i)&&d;f=v?this.children[0].radiusInner.current()*gRadius:gRadius,context.globalAlpha=p,r!=f&&(drawWedge(n,o,r,f,y,this.alphaPattern.current()),v&&o>s&&(1>p&&(context.globalAlpha=this.alphaOther.current(),drawWedge(s,o,f,gRadius,colorUnclassified,0),context.globalAlpha=p),drawWedge(s,o,f,gRadius,y,this.alphaPattern.current())),gRadius>f&&(context.beginPath(),context.arc(0,0,f,n,o,!1),context.strokeStyle=y,context.lineWidth=1,context.stroke())),this.keyed&&t&&showKeys&&this.drawKey((n+o)/2,this==highlightedNode||this==focusNode||this.searchResults,this==highlightedNode||this==focusNode)}}if(d)for(var w=0;w<this.children.length;w++)this.drawHiddenChildren(w,t,e,a)?w=this.children[w].hiddenEnd:this.children[w].draw(e,t,a)},this.drawHiddenChildren=function(e,t,a,i){var s=this.children[e];if(null==s.hiddenEnd||1==s.radiusInner.current())return!1;for(var n=e;n<s.hiddenEnd;n++)if(!this.children[n].hide||!this.children[n].hidePrev&&1>progress)return!1;var o=s.angleStart.current()+rotationOffset,r=this.children[s.hiddenEnd],h=r.angleEnd.current()+rotationOffset,d=gRadius*s.radiusInner.current(),l=s.hiddenEnd-e+1;if(a){for(var c=0,n=e;n<=s.hiddenEnd;n++)c+=this.children[n].searchResults,0==this.children[n].magnitude&&l--;(t&&(h-o)*(gRadius+gRadius)>=minWidth()||this==highlightedNode&&l||c)&&(context.globalAlpha=this.alphaWedge.current(),this.drawHiddenLabel(o,h,l,c))}for(var u=!0,n=e;n<=s.hiddenEnd;n++)if(this.children[n].alphaPattern.current()!=this.children[n].alphaWedge.current()){u=!1;break}if(a){if(u){var g=h<this.angleEnd.current()+rotationOffset;this.drawLines(o,h,d,g)}c&&!i&&drawWedge(o,h,d,gRadius,highlightFill,0,!0)}else if(u){context.globalAlpha=this.alphaWedge.current();var p=rgbText(s.r.current(),s.g.current(),s.b.current());drawWedge(o,h,d,gRadius,p,context.globalAlpha,!1)}return u},this.drawHiddenLabel=function(e,t,a,i){var s=(e+t)/2,n=gRadius+fontSize;drawTick(gRadius-.75*fontSize,1.5*fontSize,s),drawTextPolar(a.toString()+" more",0,s,n,!0,i,this==highlightedNode||this==focusNode,!1,i)},this.drawHighlight=function(e){var t=this.angleStart.current()+rotationOffset,a=this.angleEnd.current()+rotationOffset,i=this.radiusInner.current()*gRadius;this==focusNode&&this==highlightedNode&&this.hasChildren()?arrow(t,a,i):drawWedge(t,a,i,gRadius,highlightFill,0,!0);for(var s=0;s<this.children.length;s++)if(this.children[s].getDepth()-selectedNode.getDepth()+1<=maxDisplayDepth&&null!=this.children[s].hiddenEnd){var n=this.children[s],o=this.children[n.hiddenEnd],r=n.angleStart.current()+rotationOffset,h=o.angleEnd.current()+rotationOffset,d=gRadius*n.radiusInner.current();drawWedge(r,h,d,gRadius,"rgba(255, 255, 255, .3)",0,!0),s=n.hiddenEnd}context.fillStyle="black";var l=(a+t)/2;this.keyed&&showKeys||this.drawLabel(l,!0,e,!0,this.radial)},this.drawHighlightCenter=function(){this.canDisplayHistory()&&(context.lineWidth=highlightLineWidth,context.strokeStyle="black",context.fillStyle="rgba(255, 255, 255, .6)",context.fillStyle="black",this.drawLabel(3*Math.PI/2,!0,!0,!1),context.font=fontNormal)},this.drawKey=function(e,t,a){var i,s,n,o=keyOffset(),r=0==this.magnitude?"gray":"black",h=this.alphaPattern.end,d=imageWidth-keySize-margin,l=o+keySize/2;this==selectedNode?(i=colorUnclassified,s=this.getUnclassifiedText()+"   "+this.getUnclassifiedPercentage(),n=measureText(s,!1)):(s=this.keyLabel,i=rgbText(this.r.end,this.g.end,this.b.end),t?(this.searchResultChildren()&&(s+=searchResultString(this.searchResultChildren())),n=measureText(s,a)):n=this.keyNameWidth);var c=d-keyBuffer-n-fontSize/2,u=c;u>keyMinTextLeft-fontSize/2&&(keyMinTextLeft-=fontSize/2,centerX-gRadius+fontSize/2>keyMinTextLeft&&(keyMinTextLeft=centerX-gRadius+fontSize/2),u=keyMinTextLeft);var g,p,f=new Array,m=new Array,b=Math.atan((l-centerY)/(u-centerX));0>b&&(b+=Math.PI),(0==keyMinAngle||keyMinAngle>e)&&(keyMinAngle=e),e>Math.PI&&keyMinAngle>Math.PI&&(e-=2*Math.PI),f.push(Math.cos(e)*gRadius),m.push(Math.sin(e)*gRadius),g=b>e&&l>centerY+Math.sin(e)*(gRadius+buffer*(currentKey-1)/(keys+1)/2+buffer/2)?gRadius+buffer-buffer*currentKey/(keys+1)/2:gRadius+buffer*currentKey/(keys+1)/2+buffer/2;var x=Math.sqrt(Math.pow(u-centerX,2)+Math.pow(l-centerY,2))>g;if(x?(keyMinTextLeft=min(keyMinTextLeft,u-fontSize/2),p=b>e?Math.PI/2-keyLineAngle(Math.PI/2-e,Math.PI/2-b,g,l-centerY,u-centerX,m,f):keyLineAngle(e,b,g,u-centerX,l-centerY,f,m)):(p=Math.asin((l-centerY)/g),keyMinTextLeft=min(keyMinTextLeft,centerX+g*Math.cos(p)-fontSize/2),c>u&&c>centerX+g*Math.cos(p)&&(f.push(c-centerX),m.push(l-centerY))),(u>centerX+g*Math.cos(p)||l>centerY+g*Math.sin(p)+.01)&&(f.push(u-centerX),m.push(l-centerY),c!=u&&(f.push(c-centerX),m.push(l-centerY))),context.globalAlpha=this.alphaWedge.current(),snapshotMode){var y;y=this==selectedNode?this.getUnclassifiedText()+spacer()+this.getUnclassifiedPercentage():this.name+spacer()+this.getPercentage()+"%",svg+='<rect fill="'+i+'" x="'+d+'" y="'+o+'" width="'+keySize+'" height="'+keySize+'"/>',h&&(svg+='<rect fill="url(#hiddenPattern)" style="stroke:none" x="'+d+'" y="'+o+'" width="'+keySize+'" height="'+keySize+'"/>'),svg+='<path class="line'+(t?" highlight":"")+'" d="M '+(f[0]+centerX)+","+(m[0]+centerY),e!=p&&(svg+=" L "+(centerX+g*Math.cos(e))+","+(centerY+g*Math.sin(e))+" A "+g+","+g+" 0 0,"+(e>p?"0":"1")+" "+(centerX+g*Math.cos(p))+","+(centerY+g*Math.sin(p)));for(var v=1;v<f.length;v++)svg+=" L "+(centerX+f[v])+","+(centerY+m[v]);svg+='"/>',t&&(this.searchResultChildren()&&(y+=searchResultString(this.searchResultChildren())),drawBubbleSVG(d-keyBuffer-n-fontSize/2,l-fontSize,n+fontSize,2*fontSize,fontSize,0),this.isSearchResult&&drawSearchHighlights(s,d-keyBuffer-n,l,0)),svg+=svgText(y,d-keyBuffer,l,"end",a,r)}else{if(context.fillStyle=i,context.translate(-centerX,-centerY),context.strokeStyle="black",context.globalAlpha=1,context.fillRect(d,o,keySize,keySize),h&&(context.globalAlpha=h,context.fillStyle=hiddenPattern,context.beginPath(),context.moveTo(d,o),context.lineTo(d+keySize,o),context.lineTo(d+keySize,o+keySize),context.lineTo(d,o+keySize),context.closePath(),context.save(),context.clip(),context.fillRect(d,o,keySize,keySize),context.fillRect(d,o,keySize,keySize),context.restore()),t?(this.setHighlightStyle(),context.fillRect(d,o,keySize,keySize)):context.lineWidth=thinLineWidth,context.strokeRect(d,o,keySize,keySize),f.length){context.beginPath(),context.moveTo(f[0]+centerX,m[0]+centerY),context.arc(centerX,centerY,g,e,p,e>p);for(var v=1;v<f.length;v++)context.lineTo(f[v]+centerX,m[v]+centerY);context.globalAlpha=this==selectedNode?this.children[0].alphaWedge.current():this.alphaWedge.current(),context.lineWidth=t?highlightLineWidth:thinLineWidth,context.stroke(),context.globalAlpha=1}t&&(drawBubbleCanvas(d-keyBuffer-n-fontSize/2,l-fontSize,n+fontSize,2*fontSize,fontSize,0),this.isSearchResult&&drawSearchHighlights(s,d-keyBuffer-n,l,0)),drawText(s,d-keyBuffer,o+keySize/2,0,"end",a,r),context.translate(centerX,centerY)}currentKey++},this.drawLabel=function(e,t,a,i,s){if(0!=context.globalAlpha){var n,o,r;if(r=s?(this.radiusInner.current()+1)*gRadius/2:this.labelRadius.current()*gRadius,s&&(i||t)){var h=this.getPercentage();n=h+"%"}o=s||this==selectedNode||t||zoomOut&&this==selectedNodeLast?this.name:this.shortenLabel();var d=drawTextPolar(o,n,e,r,s,t,a,this.isSearchResult&&(!i||this==selectedNode||t),this.hideAlone||!i||this==selectedNode?this.searchResultChildren():0),l=this.getDepth()-selectedNode.getDepth()+1;if(!s&&!t&&this!=selectedNode&&this.angleEnd.end!=this.angleStart.end&&nLabelOffsets[l-2]>2&&this.labelWidth.current()>(this.angleEnd.end-this.angleStart.end)*Math.abs(r)&&(!zoomOut||this!=selectedNodeLast)&&this.labelRadius.end>0){var c=compress?(compressedRadii[l-1]+compressedRadii[l-2])/2:(l-.5)*nodeRadius;this.labelRadius.end>c?d?drawTick(r-1.4*tickLength,tickLength,e):drawTick(r-1.7*tickLength,tickLength,e):d?drawTick(r+.7*tickLength,tickLength,e):drawTick(r+.4*tickLength,tickLength,e)}}},this.drawLines=function(e,t,a,i){if(snapshotMode){if(this!=selectedNode){t==e+2*Math.PI&&(t-=.1/gRadius);var s=t-e>Math.PI?1:0,n=centerX+a*Math.cos(e),o=centerY+a*Math.sin(e),r=centerX+gRadius*Math.cos(e),h=centerY+gRadius*Math.sin(e),d=centerX+gRadius*Math.cos(t),l=centerY+gRadius*Math.sin(t),c=centerX+a*Math.cos(t),u=centerY+a*Math.sin(t);if(this.alphaArc.end){var g=[" M ",c,",",u," A ",a,",",a," 0 ",s," 0 ",n,",",o];svg+='<path class="line" d="'+g.join("")+'"/>'}i&&this.alphaLine.end&&(svg+='<line x1="'+d+'" y1="'+l+'" x2="'+c+'" y2="'+u+'"/>')}}else if(context.lineWidth=thinLineWidth,context.strokeStyle="black",context.beginPath(),context.arc(0,0,a,e,t,!1),context.globalAlpha=this.alphaArc.current(),context.stroke(),i){var n=a*Math.cos(t),o=a*Math.sin(t),r=gRadius*Math.cos(t),h=gRadius*Math.sin(t);context.beginPath(),context.moveTo(n,o),context.lineTo(r,h),context.globalAlpha=this.alphaLine.current(),context.stroke()}},this.drawMap=function(e){if(this.parent&&this.parent.drawMap(e),!(this.getCollapse()&&this!=e||this==focusNode)){var t=(e.baseMagnitude-this.baseMagnitude)/this.magnitude*Math.PI*2+rotationOffset,a=(e.baseMagnitude-this.baseMagnitude+e.magnitude)/this.magnitude*Math.PI*2+rotationOffset,i=this.getMapPosition();context.save(),context.fillStyle="black",context.textAlign="end",context.textBaseline="middle";var s=i.x-mapRadius-mapBuffer,n=getPercentage(e.magnitude/this.magnitude),o=this==selectedNode||this==highlightedNode;context.font=o?fontBold:fontNormal,context.fillText(n+"% of",s,i.y-mapRadius/3),context.fillText(this.name,s,i.y+mapRadius/3),o&&(context.font=fontNormal),context.fillStyle=this==highlightedNode&&this!=selectedNode?"rgb(245, 245, 245)":"rgb(255, 255, 255)",context.beginPath(),context.arc(i.x,i.y,mapRadius,0,2*Math.PI,!0),context.closePath(),context.fill(),this==selectedNode?(context.lineWidth=1,context.fillStyle="rgb(100, 100, 100)"):this==highlightedNode?(context.lineWidth=.2,context.fillStyle="rgb(190, 190, 190)"):(context.lineWidth=.2,context.fillStyle="rgb(200, 200, 200)");var r=this.getMaxDepth();!compress&&r>maxPossibleDepth+this.getDepth()-1&&(r=maxPossibleDepth+this.getDepth()-1),this.getDepth()<selectedNode.getDepth()&&e.getDepth()-1>=r&&(r=e.getDepth());var h;h=compress?0:(e.getDepth()-this.getDepth())/(r-this.getDepth()+1),context.stroke(),context.beginPath(),0==h?context.moveTo(i.x,i.y):context.arc(i.x,i.y,mapRadius*h,a,t,!0),context.arc(i.x,i.y,mapRadius,t,a,!1),context.closePath(),context.fill(),this==highlightedNode&&this!=selectedNode&&(context.lineWidth=1,context.stroke()),context.restore()}},this.drawReferenceRings=function(e){snapshotMode?(svg+='<circle cx="'+centerX+'" cy="'+centerY+'" r="'+e+'"/>',svg+='<circle cx="'+centerX+'" cy="'+centerY+'" r="'+gRadius+'"/>'):(context.globalAlpha=1-this.alphaLine.current(),context.beginPath(),context.arc(0,0,e,0,2*Math.PI,!1),context.stroke(),context.beginPath(),context.arc(0,0,gRadius,0,2*Math.PI,!1),context.stroke())},this.getCollapse=function(){return collapse&&this.collapse&&this.depth!=maxAbsoluteDepth},this.getDepth=function(){return collapse?this.depthCollapsed:this.depth},this.getMagnitude=function(){return this.attributes[magnitudeIndex][currentDataset]},this.getMapPosition=function(){return{x:details.offsetLeft+details.clientWidth-mapRadius,y:(focusNode.getDepth()-this.getDepth())*(mapBuffer+2*mapRadius)-mapRadius+details.clientHeight+details.offsetTop}},this.getMaxDepth=function(){return collapse?this.maxDepthCollapsed:this.maxDepth>maxAbsoluteDepth?maxAbsoluteDepth:this.maxDepth},this.getData=function(e,t){var a=new Array;if(null!=this.attributes[e]&&null!=this.attributes[e][currentDataset]&&""!=this.attributes[e][currentDataset]&&a.push(document.location+".files/"+this.attributes[e][currentDataset]),t)for(var i=0;i<this.children.length;i++)a=a.concat(this.children[i].getData(e,!0));return a},this.getList=function(e,t){var a;if(a=null!=this.attributes[e]&&null!=this.attributes[e][currentDataset]?this.attributes[e][currentDataset]:new Array,t)for(var i=0;i<this.children.length;i++)a=a.concat(this.children[i].getList(e,!0));return a},this.getParent=function(){for(var e=this.parent;0!=e&&e.getCollapse();)e=e.parent;return e},this.getPercentage=function(){return getPercentage(this.magnitude/selectedNode.magnitude)},this.getUnclassifiedPercentage=function(){var e=this.children[this.children.length-1];return getPercentage((this.baseMagnitude+this.magnitude-e.magnitude-e.baseMagnitude)/this.magnitude)+"%"},this.getUnclassifiedText=function(){return"[unassigned "+this.name+"]"},this.getUncollapsed=function(){return this.getCollapse()?this.children[0].getUncollapsed():this},this.hasChildren=function(){return this.children.length&&this.depth<maxAbsoluteDepth&&this.magnitude},this.hasParent=function(e){return this.parent?this.parent==e?!0:this.parent.hasParent(e):!1},this.maxVisibleDepth=function(e){var t,a=this.getDepth()-selectedNode.getDepth()+1,i=a;if(this.hasChildren()&&e>a){var s=this.children[this.children.length-1];if("Pseudomonadaceae"==this.name);s.baseMagnitude+s.magnitude<this.baseMagnitude+this.magnitude&&i++,t=compress?compressedRadii[a-1]:a/e;for(var n=0;n<this.children.length;n++)if(this.children[n].magnitude*angleFactor*(t+1)*gRadius>=minWidth()){var o=this.children[n].maxVisibleDepth(e);o>i&&(i=o)}}return i},this.resetLabelWidth=function(){var e=this.nameWidth;if(!this.radial){var t=context.measureText(this.name);this.nameWidth=t.width}this.labelWidth.start=fontSize!=fontSizeLast&&this.labelWidth.end==e*labelWidthFudge?this.nameWidth*labelWidthFudge:this.labelWidth.current(),this.labelWidth.end=this.nameWidth*labelWidthFudge},this.restrictLabelWidth=function(e){e<this.labelWidth.end&&(this.labelWidth.end=e)},this.search=function(){this.isSearchResult=!1,this.searchResults=0,this.getCollapse()||""==search.value||-1==this.name.toLowerCase().indexOf(search.value.toLowerCase())||(this.isSearchResult=!0,this.searchResults=1,nSearchResults++);for(var e=0;e<this.children.length;e++)this.searchResults+=this.children[e].search();return this.searchResults},this.searchResultChildren=function(){return this.isSearchResult?this.searchResults-1:this.searchResults},this.setDepth=function(e,t){this.depth=e,this.depthCollapsed=t,1==this.children.length&&this.children[0].magnitude==this.magnitude&&(head.children.length>1||this.children[0].children.length)?this.collapse=!0:(this.collapse=!1,t++);for(var a=0;a<this.children.length;a++)this.children[a].setDepth(e+1,t)},this.setHighlightStyle=function(){context.lineWidth=highlightLineWidth,this.hasChildren()||this!=focusNode||this!=highlightedNode?(context.strokeStyle="black",context.fillStyle="rgba(255, 255, 255, .3)"):(context.strokeStyle="rgb(90,90,90)",context.fillStyle="rgba(155, 155, 155, .3)")},this.setLabelWidth=function(e){if(shorten&&!this.radial){if(e.hide)return void alert("wtf");var t,a=(this.angleStart.end+this.angleEnd.end)/2;if(t=Math.abs(e==selectedNode?a-e.angleOther:a-(e.angleStart.end+e.angleEnd.end)/2),0!=t)if(t>Math.PI&&(t=2*Math.PI-t),e.radial||e==selectedNode){var i;if(i=e==selectedNode?(e.children[0].radiusInner.end+1)/2:(e.radiusInner.end+1)/2,t<Math.PI/2){var s=this.labelRadius.end*gRadius+.5*fontSize,n=s/Math.cos(t),o=s*Math.tan(t),r=.8*fontSize;n>i*gRadius&&this.labelWidth.end/2+r>o&&(this.labelWidth.end=2*(o-r))}}else if(this.labelRadius.end==e.labelRadius.end&&t<Math.PI/4){var h=t*this.labelRadius.end*gRadius-fontSize*(1-4*t/Math.PI)*1.3;this.labelWidth.end<h?e.restrictLabelWidth(2*(h-this.labelWidth.end/2)):e.labelWidth.end<h?this.restrictLabelWidth(2*(h-e.labelWidth.end/2)):(this.labelWidth.end=h,e.labelWidth.end=h)}else{var d=this.labelRadius.end*gRadius,l=e.labelRadius.end*gRadius,c=.35*fontSize;this.labelRadius.end<e.labelRadius.end?(d+=c,l-=c):this.labelRadius.end>e.labelRadius.end?(d-=c,l+=c):(d-=c,l-=c);var u=d*d,g=l*l,h=Math.sqrt(u+g-2*d*l*Math.cos(t)),p=Math.acos((u+h*h-g)/(2*d*h)),f=Math.sin(t+p-Math.PI/2)*h/Math.sin(Math.PI-t),m=Math.sin(Math.PI/2-p)*h/Math.sin(Math.PI-t);f=Math.abs(f)-.4*fontSize,m=Math.abs(m)-.4*fontSize,this.labelWidth.end/2>f&&e.labelWidth.end/2>m&&(f>m?this.restrictLabelWidth(2*f):e.restrictLabelWidth(2*m))}}},this.setMagnitudes=function(e){this.magnitude=this.getMagnitude(),this.baseMagnitude=e;for(var t=0;t<this.children.length;t++)this.children[t].setMagnitudes(e),e+=this.children[t].magnitude;this.maxChildMagnitude=e},this.setMaxDepths=function(){this.maxDepth=this.depth,this.maxDepthCollapsed=this.depthCollapsed;for(i in this.children){var e=this.children[i];e.setMaxDepths(),e.maxDepth>this.maxDepth&&(this.maxDepth=e.maxDepth),e.maxDepthCollapsed>this.maxDepthCollapsed&&(e.depth<=maxAbsoluteDepth||0==maxAbsoluteDepth)&&(this.maxDepthCollapsed=e.maxDepthCollapsed)}},this.setTargetLabelRadius=function(){var e=this.getDepth()-selectedNode.getDepth()+1,t=e-2,a=labelOffsets[t];if(this.radial){var i=e==maxDisplayDepth?1:compressedRadii[t+1];this.labelRadius.setTarget((compressedRadii[t]+i)/2)}else{var s,n;compress?this.labelRadius.setTarget(nLabelOffsets[t]>1?lerp(a+.75,0,nLabelOffsets[t]+.5,compressedRadii[t],compressedRadii[t+1]):(compressedRadii[t]+compressedRadii[t+1])/2):(s=nodeRadius*(e-1)+nodeRadius/2,n=nodeRadius,this.labelRadius.setTarget(s+n*((a+1)/(nLabelOffsets[t]+1)-.5)))}if(this.hide||this.keyed||!nLabelOffsets[t])this.hide&&(this.labelWidth.end=0);else{for(var o=0;maxDisplayDepth-1>o;o++)for(var r=0;r<=nLabelOffsets[o];r++){var h=labelLastNodes[o][r],d=labelFirstNodes[o][r];h&&(r==nLabelOffsets[o]?this.setLabelWidth(h):h.setLabelWidth(this)),d&&(r==nLabelOffsets[o]?this.setLabelWidth(d):d.setLabelWidth(this))}selectedNode.canDisplayLabelOther&&this.setLabelWidth(selectedNode),this.radial?(labelLastNodes[t][nLabelOffsets[t]]=this,0==labelFirstNodes[t][nLabelOffsets[t]]&&(labelFirstNodes[t][nLabelOffsets[t]]=this)):(labelLastNodes[t][a]=this,labelOffsets[t]+=1,labelOffsets[t]>nLabelOffsets[t]?(labelOffsets[t]-=nLabelOffsets[t],1&nLabelOffsets[t]||labelOffsets[t]--):labelOffsets[t]==nLabelOffsets[t]&&(labelOffsets[t]-=nLabelOffsets[t]),0==labelFirstNodes[t][a]&&(labelFirstNodes[t][a]=this))}},this.setTargets=function(){if(this==selectedNode)return void this.setTargetsSelected(0,1,lightnessBase,!1,!1);var e=this.getDepth()-selectedNode.getDepth(),t=selectedNode.hasParent(this);if(t)this.resetLabelWidth();else{var a=context.measureText(this.name);this.nameWidth=a.width,this.labelWidth.setTarget(0)}this.angleStart.setTarget(this.baseMagnitude<=selectedNode.baseMagnitude?0:2*Math.PI),this.angleEnd.setTarget(t||this.baseMagnitude+this.magnitude>=selectedNode.baseMagnitude+selectedNode.magnitude?2*Math.PI:0);for(var i=0;i<this.children.length;i++)this.children[i].setTargets();if(this.getDepth()<=selectedNode.getDepth()?(this.radiusInner.setTarget(0),this.labelRadius.setTarget(t?e*historySpacingFactor*fontSize/gRadius:0)):e+1>maxDisplayDepth?(this.radiusInner.setTarget(1),this.labelRadius.setTarget(1)):(this.radiusInner.setTarget(compress?compressedRadii[e-1]:nodeRadius*e),this.labelRadius.setTarget(this==selectedNode?0:compress?(compressedRadii[e-1]+compressedRadii[e])/2:nodeRadius*e+nodeRadius/2)),this.r.setTarget(255),this.g.setTarget(255),this.b.setTarget(255),this.alphaLine.setTarget(0),this.alphaArc.setTarget(0),this.alphaWedge.setTarget(0),this.alphaPattern.setTarget(0),this.alphaOther.setTarget(0),t&&!this.getCollapse()){var s=1-(selectedNode.getDepth()-this.getDepth())/(Math.floor((compress?compressedRadii[0]:nodeRadius)*gRadius/(historySpacingFactor*fontSize)-.5)+1);0>s&&(s=0),this.alphaLabel.setTarget(s),this.radial=!1}else this.alphaLabel.setTarget(0);this.hideAlonePrev=this.hideAlone,this.hidePrev=this.hide,t&&(this.hideAlone=!1,this.hide=!1),this.getParent()==selectedNode.getParent()&&(this.hiddenEnd=null),this.radialPrev=this.radial},this.setTargetsSelected=function(e,t,a,i,s){var n,o=this.getCollapse(),r=this.getDepth()-selectedNode.getDepth()+1,h=!1;this.hasChildren()?(n=this.children[this.children.length-1],this.hideAlone=!0):this.hideAlone=!1;for(var d=0;d<this.children.length;d++)this.children[d].setTargetWedge(),!this.children[d].hide&&(o||maxDisplayDepth>r)&&this.depth<maxAbsoluteDepth&&(h=!0,this.hideAlone=!1);if((this==selectedNode||n&&n.angleEnd.end<this.angleEnd.end-.01)&&(this.hideAlone=!1),void 0==this.hideAlonePrev&&(this.hideAlonePrev=this.hideAlone),this==selectedNode){var l=angleFactor*(this.baseMagnitude+this.magnitude-n.baseMagnitude-n.magnitude);this.canDisplayLabelOther=l*(this.children[0].radiusInner.end+1)*gRadius>=minWidth(),this.keyUnclassified=!1,this.canDisplayLabelOther?this.angleOther=2*Math.PI-l/2:l>1e-10&&(this.keyUnclassified=!0,keys++),this.angleStart.setTarget(0),this.angleEnd.setTarget(2*Math.PI),this.radiusInner.setTarget(0),this.hidePrev=this.hide,this.hide=!1,this.hideAlonePrev=this.hideAlone,this.hideAlone=!1,this.keyed=!1}t-e>1/12&&(t=e+1/12),i||this.hideAlone||(useHue()?a=(lightnessBase+lightnessMax)/2:(a=lightnessBase+(r-1)*lightnessFactor,a>lightnessMax&&(a=lightnessMax))),i&&(this.hide=!0),void 0==this.hidePrev&&(this.hidePrev=this.hide);var c=-1,u=0,g=0,d=0;for(this.hide||(this.hiddenEnd=null);;){if(!(this.hideAlone||i||d!=this.children.length&&this.children[d].hide)&&-1!=c){for(var p=g?u/g:e,f=c;d>f;f++)this.children[f].setTargetsSelected(p,null,a,!1,d-1>f),this.children[f].hiddenEnd=null;this.children[c].hiddenEnd=d-1}if(d==this.children.length)break;var m,b,x=this.children[d];if(this.magnitude>0&&!this.hide&&!this.hideAlone)if(useHue())m=x.hues[currentDataset];else if(this==selectedNode){var y=0,v=1;this.children.length>6?(m=lerp(.95*(1-Math.pow(1-d/this.children.length,1.4)),0,1,y,v),b=lerp(.95*(1-Math.pow(1-(d+.55)/this.children.length,1.4)),0,1,y,v)):(m=lerp(d/this.children.length,0,1,y,v),b=lerp((d+.55)/this.children.length,0,1,y,v))}else m=lerp(x.baseMagnitude,this.baseMagnitude,this.baseMagnitude+this.magnitude,e,t),b=lerp(x.baseMagnitude+.99*x.magnitude,this.baseMagnitude,this.baseMagnitude+this.magnitude,e,t);else m=e,b=t;this.hideAlone||i||this.hide||!x.hide?(c=-1,this.children[d].setTargetsSelected(m,b,a,i||this.keyed||this.hideAlone||this.hide&&!o,!1)):(-1==c&&(c=d),useHue()?(u+=m*x.magnitude,g+=x.magnitude):(u+=m,g++)),d++}if(this.hue&&this.magnitude&&(this.hue.setTarget(this.hues[currentDataset]),0==this.attributes[magnitudeIndex][lastDataset]&&(this.hue.start=this.hue.end)),this.radialPrev=this.radial,this==selectedNode)this.resetLabelWidth(),this.labelWidth.setTarget(this.nameWidth*labelWidthFudge),this.alphaWedge.setTarget(0),this.alphaLabel.setTarget(1),this.alphaOther.setTarget(1),this.alphaArc.setTarget(0),this.alphaLine.setTarget(0),this.alphaPattern.setTarget(0),this.r.setTarget(255),this.g.setTarget(255),this.b.setTarget(255),this.radial=!1,this.labelRadius.setTarget(0);else{var w=hslToRgb(e,saturation,a);if(this.r.setTarget(w.r),this.g.setTarget(w.g),this.b.setTarget(w.b),this.alphaOther.setTarget(0),this.alphaWedge.setTarget(1),this.alphaPattern.setTarget(this.hide||this.hideAlone?1:0),!i&&!this.hide)if(this.hideAlone)this.radial=!0;else if(this.radial=!0,this.hasChildren()&&maxDisplayDepth>r){var n=this.children[this.children.length-1];(n.angleEnd.end==this.angleEnd.end||((this.angleStart.end+this.angleEnd.end)/2-n.angleEnd.end)*(this.radiusInner.end+1)*gRadius*2<minWidth())&&(this.radial=!1)}o||i||this.hide||this.keyed||r>maxDisplayDepth||!this.canDisplayDepth()?this.alphaLabel.setTarget(0):this.radial||nLabelOffsets[r-2]?this.alphaLabel.setTarget(1):(this.alphaLabel.setTarget(0),this.radialPrev&&(this.alphaLabel.start=0)),this.alphaArc.setTarget(o||i||r>maxDisplayDepth||!this.canDisplayDepth()?0:1),this.alphaLine.setTarget(i||this.hide&&s||r>maxDisplayDepth||!this.canDisplayDepth()?0:1),this.resetLabelWidth(),o?this.labelRadius.setTarget(this.radiusInner.end):r>maxDisplayDepth||!this.canDisplayDepth()?this.labelRadius.setTarget(1):this.setTargetLabelRadius()}},this.setTargetWedge=function(){var e=this.getDepth()-selectedNode.getDepth()+1,t=this.baseMagnitude-selectedNode.baseMagnitude;if(this.angleStart.setTarget(t*angleFactor),this.angleEnd.setTarget((t+this.magnitude)*angleFactor),this.radiusInner.setTarget(e>maxDisplayDepth||!this.canDisplayDepth()?1:compress?compressedRadii[e-2]:nodeRadius*(e-1)),void 0!=this.hide&&(this.hidePrev=this.hide),void 0!=this.hideAlone&&(this.hideAlonePrev=this.hideAlone),(this.angleEnd.end-this.angleStart.end)*(this.radiusInner.end*gRadius+gRadius)<minWidth())if(2==e&&!this.getCollapse()&&this.depth<=maxAbsoluteDepth){this.keyed=!0,keys++,this.hide=!1;var a=this.getPercentage();this.keyLabel=this.name+"   "+a+"%";var i=context.measureText(this.keyLabel);this.keyNameWidth=i.width}else this.keyed=!1,this.hide=e>2;else this.keyed=!1,this.hide=!1},this.shortenLabel=function(){var e=this.name,t=this.nameWidth,a=this.labelWidth.current(),i=0;if(t>a&&e.length>2*i){var s=Math.floor((e.length-1)*a/t/2);return i>s&&(s=i),e.substring(0,s)+"..."+e.substring(e.length-s)}return e},this.sort=function(){this.children.sort(function(e,t){return t.getMagnitude()-e.getMagnitude()});for(var e=0;e<this.children.length;e++)this.children[e].sort()}}function addOptionElement(e,t,a){var i=document.createElement("div");i.innerHTML=t,i.style.padding="2px",a&&(i.title=a),options.appendChild(i);var s=0;return e+s}function addOptionElements(e,t){options=document.createElement("div"),options.style.position="absolute",options.style.top="0px",options.addEventListener("mousedown",function(e){mouseClick(e)},!1),document.body.appendChild(options),document.body.style.font="11px sans-serif";var a=5;details=document.createElement("div"),details.style.position="absolute",details.style.top="1%",details.style.right="2%",details.style.textAlign="right",document.body.insertBefore(details,canvas),details.innerHTML='<span id="detailsName" style="font-weight:bold"></span>&nbsp;<input type="button" id="detailsExpand" onclick="expand(focusNode);"value="&harr;" title="Expand this wedge to become the new focus of the chart"/><br/><div id="detailsInfo" style="float:right"></div>',keyControl=document.createElement("input"),keyControl.type="button",keyControl.value=showKeys?"x":"…",keyControl.style.position="",keyControl.style.position="fixed",keyControl.style.visibility="hidden",document.body.insertBefore(keyControl,canvas);
var i=document.getElementById("logo");if(logoImage=i?i.src:"http://krona.sourceforge.net/img/logo.png",a=addOptionElement(a,'<a style="margin:2px" target="_blank" href="http://krona.sourceforge.net"><div style="display:inline-block;vertical-align:middle;background-color:#EEEEEE;border:1px solid gray;padding:2px;font-size:18px"><img style="vertical-align:middle;" src="'+logoImage+'"/><span style="vertical-align:middle;color:#555555">Krona</span></div></a><input type="button" id="back" value="&larr;" title="Go back (Shortcut: &larr;)"/><input type="button" id="forward" value="&rarr;" title="Go forward (Shortcut: &rarr;)"/> &nbsp;Search: <input type="text" id="search"/><input id="searchClear" type="button" value="x" onclick="clearSearch()"/> <span id="searchResults"></span>'),datasets>1){for(var s=datasetSelectSize>datasets?datasets:datasetSelectSize,n='<table style="border-collapse:collapse;padding:0px"><tr><td style="padding:0px"><select id="datasets" style="min-width:100px" size="'+s+'" onchange="onDatasetChange()">',o=0;o<datasetNames.length;o++)n+="<option>"+datasetNames[o]+"</option>";n+='</select></td><td style="vertical-align:top;padding:1px;"><input style="display:block" title="Previous dataset (Shortcut: &uarr;)" id="prevDataset" type="button" value="&uarr;" onclick="prevDataset()" disabled="true"/><input title="Next dataset (Shortcut: &darr;)" id="nextDataset" type="button" value="&darr;" onclick="nextDataset()"/><br/></td><td style="padding-top:1px;vertical-align:top"><input title="Switch to the last dataset that was viewed (Shortcut: TAB)" id="lastDataset" type="button" style="font:11px Times new roman" value="last" onclick="selectLastDataset()"/></td></tr></table>',a=addOptionElement(a+5,n),datasetDropDown=document.getElementById("datasets"),datasetButtonLast=document.getElementById("lastDataset"),datasetButtonPrev=document.getElementById("prevDataset"),datasetButtonNext=document.getElementById("nextDataset"),a+=datasetDropDown.clientHeight}a=addOptionElement(a+5,'<input type="button" id="maxAbsoluteDepthDecrease" value="-"/><span id="maxAbsoluteDepth"></span>&nbsp;<input type="button" id="maxAbsoluteDepthIncrease" value="+"/> Max depth',"Maximum depth to display, counted from the top level and including collapsed wedges."),a=addOptionElement(a,'<input type="button" id="fontSizeDecrease" value="-"/><span id="fontSize"></span>&nbsp;<input type="button" id="fontSizeIncrease" value="+"/> Font size'),a=addOptionElement(a,'<input type="button" id="radiusDecrease" value="-"/><input type="button" id="radiusIncrease" value="+"/> Chart size'),e&&(hueDisplayName=attributes[attributeIndex(e)].displayName,a=addOptionElement(a+5,'<input type="checkbox" id="useHue" style="float:left" /><div>Color by<br/>'+hueDisplayName+"</div>"),useHueCheckBox=document.getElementById("useHue"),useHueCheckBox.checked=t,useHueCheckBox.onclick=handleResize,useHueCheckBox.onmousedown=suppressEvent),a=addOptionElement(a,'<input type="checkbox" id="collapse" checked="checked" />Collapse',"Collapse wedges that are redundant (entirely composed of another wedge)"),a=addOptionElement(a+5,'<input type="button" id="snapshot" value="Snapshot"/>',"Render the current view as SVG (Scalable Vector Graphics), a publication-quality format that can be printed and saved (see Help for browser compatibility)"),a=addOptionElement(a+5,'<input type="button" id="linkButton" value="Link"/><input type="text" size="30" id="linkText"/>',"Show a link to this view that can be copied for bookmarking or sharing"),a=addOptionElement(a+5,'<input type="button" id="help" value="?"onclick="window.open(\'https://sourceforge.net/p/krona/wiki/Browsing%20Krona%20charts/\', \'help\')"/>',"Help")}function arrow(e,t,a){if(0!=context.globalAlpha){var i=(e+t)/2,s=a-gRadius/10,n=1.1*gRadius,o=(s+n)/2,r=(n-s)/5;context.fillStyle=highlightFill,context.lineWidth=highlightLineWidth,context.beginPath(),context.arc(0,0,a,i,t,!1),context.lineTo(s*Math.cos(t),s*Math.sin(t)),context.lineTo(o*Math.cos(t)-r*Math.sin(t),o*Math.sin(t)+r*Math.cos(t)),context.lineTo(n*Math.cos(t),n*Math.sin(t)),context.arc(0,0,gRadius,t,i,!0),context.closePath(),context.moveTo(-imageWidth,-imageHeight),context.lineTo(imageWidth,-imageHeight),context.lineTo(imageWidth,imageHeight),context.lineTo(-imageWidth,imageHeight),context.closePath(),context.save(),context.clip(),context.beginPath(),context.arc(0,0,a,i,e,!0),context.lineTo(s*Math.cos(e),s*Math.sin(e)),context.lineTo(o*Math.cos(e)+r*Math.sin(e),o*Math.sin(e)-r*Math.cos(e)),context.lineTo(n*Math.cos(e),n*Math.sin(e)),context.arc(0,0,gRadius,e,i,!1),context.fill(),context.stroke(),context.restore(),context.beginPath(),context.arc(0,0,a,i-2/(2*Math.PI*a),t,!1),context.lineTo(s*Math.cos(t),s*Math.sin(t)),context.lineTo(o*Math.cos(t)-r*Math.sin(t),o*Math.sin(t)+r*Math.cos(t)),context.lineTo(n*Math.cos(t),n*Math.sin(t)),context.arc(0,0,gRadius,t,i-2/(2*Math.PI*gRadius),!0),context.fill(),context.stroke()}}function attributeIndex(e){for(var t=0;t<attributes.length;t++)if(e==attributes[t].name)return t;return null}function checkHighlight(){highlightedNode=selectedNode,resetKeyOffset(),1==progress&&(selectedNode.checkHighlight(),selectedNode.getParent()&&selectedNode.getParent().checkHighlightCenter(),focusNode.checkHighlightMap()),1==progress&&draw()}function checkSelectedCollapse(){for(var e=selectedNode;e.getCollapse();)e=e.children[0];0==e.children.length&&(e=e.getParent()),e!=selectedNode&&selectNode(e)}function clearSearch(){""!=search.value&&(search.value="",onSearchChange())}function createSVG(){svgNS="http://www.w3.org/2000/svg";var e={};e.xlinkns="http://www.w3.org/1999/xlink";var t=document.createElementNS(svgNS,"svg:svg");return t.setAttribute("id","canvas"),t.setAttribute("width","100%"),t.setAttribute("height","100%"),t.setAttributeNS("http://www.w3.org/2000/xmlns/","xmlns:xlink",e.xlinkns),t}function degrees(e){return 180*e/Math.PI}function draw(){tweenFrames++,context.clearRect(0,0,imageWidth,imageHeight),context.font=fontNormal,context.textBaseline="middle",context.translate(centerX,centerY),resetKeyOffset(),head.draw(!1,!1),head.draw(!0,!1);var e=selectedNode;0!=focusNode&&focusNode!=selectedNode&&(context.globalAlpha=1,focusNode.drawHighlight(!0),e=focusNode),highlightedNode&&highlightedNode.getDepth()>=selectedNode.getDepth()&&highlightedNode!=focusNode?1==progress&&highlightedNode!=selectedNode&&(highlightedNode!=focusNode||focusNode.children.length>0)&&(context.globalAlpha=1,highlightedNode.drawHighlight(!0)):1==progress&&highlightedNode.getDepth()<selectedNode.getDepth()&&(context.globalAlpha=1,highlightedNode.drawHighlightCenter()),1>progress&&(zoomOut?selectedNodeLast&&(context.globalAlpha=1-4*Math.pow(progress-.5,2),selectedNodeLast.drawHighlight(!1)):(context.globalAlpha=selectedNode.alphaLine.current(),selectedNode.drawHighlight(!0))),drawDatasetName(),context.translate(-centerX,-centerY),context.globalAlpha=1,mapRadius=(imageHeight/2-details.clientHeight-details.offsetTop)/(e.getDepth()-1)*3/4/2,mapRadius>maxMapRadius&&(mapRadius=maxMapRadius),mapBuffer=mapRadius/2,e.drawMap(e),hueDisplayName&&useHue()&&drawLegend()}function drawBubble(e,t,a,i,s){var n,o,r=2*fontSize;a+=fontSize,i?(o=-fontSize,n=s?t-a+fontSize/2:t-fontSize/2):(n=-a/2,o=-t-fontSize),snapshotMode?drawBubbleSVG(n+centerX,o+centerY,a,r,fontSize,e):drawBubbleCanvas(n,o,a,r,fontSize,e)}function drawBubbleCanvas(e,t,a,i,s,n){context.strokeStyle="black",context.lineWidth=highlightLineWidth,context.fillStyle="rgba(255, 255, 255, .75)",context.rotate(n),roundedRectangle(e,t,a,2*fontSize,fontSize),context.fill(),context.stroke(),context.rotate(-n)}function drawBubbleSVG(e,t,a,i,s,n){svg+='<rect x="'+e+'" y="'+t+'" width="'+a+'" height="'+i+'" rx="'+s+'" ry="'+s+'" fill="rgba(255, 255, 255, .75)" class="highlight" transform="rotate('+degrees(n)+","+centerX+","+centerY+')"/>'}function drawDatasetName(){var e=datasetAlpha.current();if(e>0){var t=gRadius*compressedRadii[0]/-2;e>1&&(e=1),context.globalAlpha=e,drawBubble(0,-t,datasetWidths[currentDataset],!1,!1),drawText(datasetNames[currentDataset],0,t,0,"center",!0)}}function drawHistory(){var e=1;context.textAlign="center";for(var t=0;nodeHistoryPosition>t&&e>0;t++)context.globalAlpha=e-historyAlphaDelta*tweenFactor,context.fillText(nodeHistory[nodeHistoryPosition-t-1].name,0,(t+tweenFactor)*historySpacingFactor*fontSize-1),e>0&&(e-=historyAlphaDelta);context.globalAlpha=1}function drawLegend(){var e=.01*imageWidth,t=.0265*imageHeight,a=.15*imageHeight,i=imageHeight-3.5*fontSize-a,s=e+t+fontSize/2;context.fillStyle="black",context.textAlign="start",context.font=fontNormal,context.fillText(hueDisplayName,e,imageHeight-1.5*fontSize);for(var n=context.createLinearGradient(0,i+a,0,i),o=0;o<hueStopPositions.length;o++){n.addColorStop(hueStopPositions[o],hueStopHsl[o]);var r=i+(1-hueStopPositions[o])*a;(0==o||o==hueStopPositions.length-1||r>i+fontSize&&i+a-fontSize>r)&&context.fillText(hueStopText[o],s,r)}context.fillStyle=n,context.fillRect(e,i,t,a),context.lineWidth=thinLineWidth,context.strokeRect(e,i,t,a)}function drawLegendSVG(){var e=.01*imageWidth,t=.0265*imageHeight,a=.15*imageHeight,i=imageHeight-3.5*fontSize-a,s=e+t+fontSize/2,n="";n+=svgText(hueDisplayName,e,imageHeight-1.5*fontSize);for(var o='<linearGradient id="gradient" x1="0%" y1="100%" x2="0%" y2="0%">',r=0;r<hueStopPositions.length;r++){o+='<stop offset="'+round(100*hueStopPositions[r])+'%" style="stop-color:'+hueStopHsl[r]+'"/>';var h=i+(1-hueStopPositions[r])*a;(0==r||r==hueStopPositions.length-1||h>i+fontSize&&i+a-fontSize>h)&&(n+=svgText(hueStopText[r],s,h))}o+="</linearGradient>",svg+=o,svg+='<rect style="fill:url(#gradient)" x="'+e+'" y="'+i+'" width="'+t+'" height="'+a+'"/>',svg+=n}function drawSearchHighlights(e,t,a,i,s){var n=-1,o=e.length;t-=fontSize/4;do if(n=e.toLowerCase().indexOf(search.value.toLowerCase(),n+1),-1!=n&&o>n){var r=context.measureText(e.substr(0,n)),h=t+r.width;r=context.measureText(e.substr(n,search.value.length));var d=a-3*fontSize/4,l=r.width+fontSize/2,c=3*fontSize/2,u=fontSize/2;snapshotMode?(s&&(h+=centerX,d+=centerY),svg+='<rect x="'+h+'" y="'+d+'" width="'+l+'" height="'+c+'" rx="'+u+'" ry="'+u+'" class="searchHighlight" transform="rotate('+degrees(i)+","+centerX+","+centerY+')"/>'):(context.fillStyle="rgb(255, 255, 100)",context.rotate(i),roundedRectangle(h,d,l,c,u),context.fill(),context.rotate(-i))}while(-1!=n&&o>n)}function drawText(e,t,a,i,s,n,o){void 0==o&&(o="black"),snapshotMode?svg+='<text x="'+(centerX+t)+'" y="'+(centerY+a)+'" text-anchor="'+s+'" style="font-color:'+o+";font-weight:"+(n?"bold":"normal")+'" transform="rotate('+degrees(i)+","+centerX+","+centerY+')">'+e+"</text>":(context.fillStyle=o,context.textAlign=s,context.font=n?fontBold:fontNormal,context.rotate(i),context.fillText(e,t,a),context.rotate(-i))}function drawTextPolar(e,t,a,i,s,n,o,r,h){var d,l,c,u,g,p=e;if(u=snapshotMode?"&#160;&#160;&#160;":"   ",s)g=a<3*Math.PI/2,g?(a-=Math.PI,i=-i,d="end",t&&(p=e+u+t)):(d="start",t&&(p=t+u+e)),l=i,c=0;else{g=a<Math.PI||a>2*Math.PI;d=snapshotMode?"middle":"center",g&&(a-=Math.PI,i=-i),a+=Math.PI/2,l=0,c=-i}if(n){var f=p;t&&snapshotMode&&(f=g?e+"   "+t:t+"   "+e),h&&(f+=searchResultString(h));var m=measureText(f,o),b=l;"end"==d?b-=m:"start"!=d&&(b-=m/2),drawBubble(a,i,m,s,g),r&&drawSearchHighlights(f,b,c,a,!0)}return h&&(p+=searchResultString(h)),drawText(p,l,c,a,d,o),g}function drawTick(e,t,a){snapshotMode?svg+='<line x1="'+(centerX+e)+'" y1="'+centerY+'" x2="'+(centerX+e+t)+'" y2="'+centerY+'" class="tick" transform="rotate('+degrees(a)+","+centerX+","+centerY+')"/>':(context.rotate(a),context.beginPath(),context.moveTo(e,0),context.lineTo(e+t,0),context.lineWidth=2*thinLineWidth,context.stroke(),context.rotate(-a))}function drawWedge(e,t,a,i,s,n,o){if(0!=context.globalAlpha)if(snapshotMode){t==e+2*Math.PI&&(t-=.1/gRadius);var r=t-e>Math.PI?1:0,h=centerX+a*Math.cos(e),d=centerY+a*Math.sin(e),l=centerX+gRadius*Math.cos(e),c=centerY+gRadius*Math.sin(e),u=centerX+gRadius*Math.cos(t),g=centerY+gRadius*Math.sin(t),p=centerX+a*Math.cos(t),f=centerY+a*Math.sin(t),m=[" M ",h,",",d," L ",l,",",c," A ",gRadius,",",gRadius," 0 ",r,",1 ",u,",",g," L ",p,",",f," A ",a,",",a," 0 ",r," 0 ",h,",",d," Z "];svg+='<path class="'+(o?"highlight":"wedge")+'" fill="'+s+'" d="'+m.join("")+'"/>',n>0&&(svg+='<path class="wedge" fill="url(#hiddenPattern)" d="'+m.join("")+'"/>')}else t+=1/gRadius,context.fillStyle=s,context.beginPath(),context.arc(0,0,a,e,t,!1),context.arc(0,0,i,t,e,!0),context.closePath(),context.fill(),n>0&&(context.save(),context.clip(),context.globalAlpha=n,context.fillStyle=hiddenPattern,context.fill(),context.restore()),o&&(context.lineWidth=o?highlightLineWidth:thinLineWidth,context.strokeStyle="black",context.stroke())}function expand(e){selectNode(e),updateView()}function focusLost(){mouseX=-1,mouseY=-1,checkHighlight(),document.body.style.cursor="auto"}function fontSizeDecrease(){fontSize>1&&(fontSize--,updateViewNeeded=!0)}function fontSizeIncrease(){fontSize++,updateViewNeeded=!0}function getGetString(e,t,a){return e+"="+(a?t?"true":"false":t)}function hideLink(){hide(linkText),show(linkButton)}function show(e){e.style.display="inline"}function hide(e){e.style.display="none"}function showLink(){var e=String(document.location).split("?"),t=new Array;t.push(getGetString("dataset",currentDataset,!1),getGetString("node",selectedNode.id,!1),getGetString("collapse",collapse,!0),getGetString("color",useHue(),!0),getGetString("depth",maxAbsoluteDepth-1,!1),getGetString("font",fontSize,!1),getGetString("key",showKeys,!0)),hide(linkButton),show(linkText),linkText.value=e[0]+"?"+getVariables.concat(t).join("&"),linkText.focus(),linkText.select()}function getFirstChild(e){return e=e.firstChild,e&&1!=e.nodeType&&(e=getNextSibling(e)),e}function getNextSibling(e){do e=e.nextSibling;while(e&&1!=e.nodeType);return e}function getPercentage(e){return round(100*e)}function hslText(e){var t=hslToRgb(e,saturation,(lightnessBase+lightnessMax)/2);return rgbText(t.r,t.g,t.b)}function hslToRgb(e,t,a){var i,s,n,o,r;return 0==t?n=o=r=Math.floor(255*a):(s=.5>=a?a*(t+1):a+t-a*t,i=2*a-s,n=Math.floor(hueToRgb(i,s,e+1/3)),o=Math.floor(hueToRgb(i,s,e)),r=Math.floor(hueToRgb(i,s,e-1/3))),{r:n,g:o,b:r}}function hueToRgb(e,t,a){for(var i;0>a;)a+=1;for(;a>1;)a-=1;return i=1>6*a?e+(t-e)*a*6:1>2*a?t:2>3*a?e+(t-e)*(2/3-a)*6:e,255*i}function interpolateHue(e,t,a,i){hueStopPositions=new Array,hueStopHsl=new Array,hueStopText=new Array,hueStopPositions.push(0),hueStopHsl.push(hslText(e)),hueStopText.push(round(a));for(var s=e>t?5/6:1/6;e>t?s>0:1>s;s+=(e>t?-1:1)/6)(e>t?s>t&&e>s:s>e&&t>s)&&(hueStopPositions.push(lerp(s,e,t,0,1)),hueStopHsl.push(hslText(s)),hueStopText.push(round(lerp(s,e,t,a,i))));hueStopPositions.push(1),hueStopHsl.push(hslText(t)),hueStopText.push(round(i))}function keyLineAngle(e,t,a,i,s,n,o){if(e<Math.PI/2&&s<a*Math.sin(e)||e>Math.PI/2&&a>s)return Math.asin(s/a);var r=Math.sqrt(Math.pow(i,2)+Math.pow(s,2)),h=Math.acos(a/r)+t;return h>e||e<Math.PI/2?(s/Math.tan(e)>0?(n.push(s/Math.tan(e)),o.push(s)):(n.push(a*Math.cos(e)),o.push(a*Math.sin(e))),e):h}function keyOffset(){return imageHeight-(keys-currentKey+1)*(keySize+keyBuffer)+keyBuffer-margin}function lerp(e,t,a,i,s){return(e-t)*(s-i)/(a-t)+i}function createCanvas(){canvas=document.createElement("canvas"),document.body.appendChild(canvas),context=canvas.getContext("2d")}function load(){if(document.body.style.overflow="hidden",document.body.style.margin=0,createCanvas(),void 0==context)return void(document.body.innerHTML='<br/>This browser does not support HTML5 (see <a href="http://sourceforge.net/p/krona/wiki/Browser%20support/">Browser support</a>).	');if("function"!=typeof context.fillText)return void(document.body.innerHTML='<br/>This browser does not support HTML5 canvas text (see <a href="http://sourceforge.net/p/krona/wiki/Browser%20support/">Browser support</a>).	');resize();var e,t,a,s,n,o,r,h=document.getElementsByTagName("krona")[0];void 0!=h.getAttribute("collapse")&&(collapse="true"==h.getAttribute("collapse")),void 0!=h.getAttribute("key")&&(showKeys="true"==h.getAttribute("key"));for(var d=getFirstChild(h);d;d=getNextSibling(d))switch(d.tagName.toLowerCase()){case"attributes":e=d.getAttribute("magnitude");for(var l=getFirstChild(d);l;l=getNextSibling(l)){var c=l.tagName.toLowerCase();if("attribute"==c){var u=new Attribute;u.name=l.firstChild.nodeValue.toLowerCase(),u.displayName=l.getAttribute("display"),l.getAttribute("hrefBase")&&(u.hrefBase=l.getAttribute("hrefBase")),l.getAttribute("target")&&(u.target=l.getAttribute("target")),u.name==e&&(magnitudeIndex=attributes.length),l.getAttribute("listAll")?u.listAll=l.getAttribute("listAll").toLowerCase():l.getAttribute("listNode")?u.listNode=l.getAttribute("listNode").toLowerCase():l.getAttribute("dataAll")?u.dataAll=l.getAttribute("dataAll").toLowerCase():l.getAttribute("dataNode")&&(u.dataNode=l.getAttribute("dataNode").toLowerCase()),l.getAttribute("postUrl")&&(u.postUrl=l.getAttribute("postUrl")),l.getAttribute("postVar")&&(u.postVar=l.getAttribute("postVar")),l.getAttribute("mono")&&(u.mono=!0),attributes.push(u)}else if("list"==c){var u=new Attribute;u.name=l.firstChild.nodeValue,u.list=!0,attributes.push(u)}else if("data"==c){var u=new Attribute;u.name=l.firstChild.nodeValue,u.data=!0,attributes.push(u);var g=document.createElement("script"),p=new Date;g.src=l.getAttribute("enable")+"?"+p.getTime(),document.body.appendChild(g)}}break;case"color":t=d.getAttribute("attribute"),s=Number(d.getAttribute("hueStart"))/360,n=Number(d.getAttribute("hueEnd"))/360,o=Number(d.getAttribute("valueStart")),r=Number(d.getAttribute("valueEnd")),interpolateHue(s,n,o,r),"true"==d.getAttribute("default")&&(a=!0);break;case"datasets":for(datasetNames=new Array,j=getFirstChild(d);j;j=getNextSibling(j))datasetNames.push(j.firstChild.nodeValue);datasets=datasetNames.length;break;case"node":head=loadTreeDOM(d,e,t,s,n,o,r)}var f,m=String(document.location).split("?"),b=0,x=0;if(m[1]){var y=m[1].split("&");for(i=0;i<y.length;i++){var v=y[i].split("=");switch(v[0]){case"collapse":collapse="true"==v[1];break;case"color":a="true"==v[1];break;case"dataset":b=Number(v[1]);break;case"depth":f=Number(v[1])+1;break;case"key":showKeys="true"==v[1];break;case"font":fontSize=Number(v[1]);break;case"node":x=Number(v[1]);break;default:getVariables.push(v[0]+"="+v[1])}}}addOptionElements(t,a),setCallBacks(),head.sort(),maxAbsoluteDepth=0,selectDataset(b),maxAbsoluteDepth=f&&f<head.maxDepth?f:head.maxDepth,selectNode(nodes[x]),setInterval(update,20),window.onresize=handleResize,updateMaxAbsoluteDepth(),updateViewNeeded=!0}function loadTreeDOM(e,t,a,i,s,n,o){var r=new Node;r.name=e.getAttribute("name"),e.getAttribute("href")&&(r.href=e.getAttribute("href")),a&&(r.hues=new Array);for(var h=getFirstChild(e);h;h=getNextSibling(h))switch(h.tagName.toLowerCase()){case"node":var d=loadTreeDOM(h,t,a,i,s,n,o);d.parent=r,r.children.push(d);break;default:var l=h.tagName.toLowerCase(),c=attributeIndex(l);r.attributes[c]=new Array;for(var u=getFirstChild(h);u;u=getNextSibling(u)){if(void 0==attributes[c]);if(attributes[c].list){r.attributes[c].push(new Array);for(var g=getFirstChild(u);g;g=getNextSibling(g))r.attributes[c][r.attributes[c].length-1].push(g.firstChild.nodeValue)}else{var p=u.firstChild?u.firstChild.nodeValue:"";if(u.getAttribute("href")){var f;attributes[c].target&&(f=' target="'+attributes[c].target+'"'),p='<a href="'+attributes[c].hrefBase+u.getAttribute("href")+'"'+f+">"+p+"</a>"}r.attributes[c].push(p)}}if(l==t||l==a){for(u=0;datasets>u;u++){var p=void 0==r.attributes[c][u]?0:Number(r.attributes[c][u]);if(r.attributes[c][u]=p,l==a){var m=lerp(p,n,o,i,s);i>m==s>i?m=i:m>s==s>i&&(m=s),r.hues[u]=m}}l==a&&(r.hue=new Tween(r.hues[0],r.hues[0]))}}return r}function maxAbsoluteDepthDecrease(){maxAbsoluteDepth>2&&(maxAbsoluteDepth--,head.setMaxDepths(),handleResize())}function maxAbsoluteDepthIncrease(){maxAbsoluteDepth<head.maxDepth&&(maxAbsoluteDepth++,head.setMaxDepths(),handleResize())}function measureText(e,t){context.font=t?fontBold:fontNormal;var a=context.measureText(e);return a.width}function min(e,t){return t>e?e:t}function minWidth(){return 2.3*fontSize}function mouseMove(e){mouseX=e.pageX,mouseY=e.pageY-headerHeight,head&&!quickLook&&checkHighlight()}function mouseClick(){if(highlightedNode==focusNode&&focusNode!=selectedNode||selectedNode.hasParent(highlightedNode))highlightedNode.hasChildren()&&expand(highlightedNode);else if(1==progress){setFocus(highlightedNode),draw(),checkHighlight();var e=new Date;mouseDownTime=e.getTime(),mouseDown=!0}}function mouseUp(){quickLook&&(navigateBack(),quickLook=!1),mouseDown=!1}function navigateBack(){nodeHistoryPosition>0&&(nodeHistory[nodeHistoryPosition]=selectedNode,nodeHistoryPosition--,nodeHistory[nodeHistoryPosition].collapse&&(collapseCheckBox.checked=collapse=!1),setSelectedNode(nodeHistory[nodeHistoryPosition]),updateDatasetButtons(),updateView())}function navigateUp(){selectedNode.getParent()&&(selectNode(selectedNode.getParent()),updateView())}function navigateForward(){if(nodeHistoryPosition<nodeHistory.length-1){nodeHistoryPosition++;var e=nodeHistory[nodeHistoryPosition];e.collapse&&(collapseCheckBox.checked=collapse=!1),nodeHistoryPosition==nodeHistory.length-1&&(nodeHistory.length=nodeHistoryPosition),setSelectedNode(e),updateDatasetButtons(),updateView()}}function nextDataset(){var e=currentDataset;do e==datasets-1?e=0:e++;while(datasetDropDown.options[e].disabled);selectDataset(e)}function onDatasetChange(){selectDataset(datasetDropDown.selectedIndex)}function onKeyDown(e){37==e.keyCode&&"search"!=document.activeElement.id&&"linkText"!=document.activeElement.id?(navigateBack(),e.preventDefault()):39==e.keyCode&&"search"!=document.activeElement.id&&"linkText"!=document.activeElement.id?(navigateForward(),e.preventDefault()):38==e.keyCode&&datasets>1?(prevDataset(),e.preventDefault()):40==e.keyCode&&datasets>1?(nextDataset(),e.preventDefault()):9==e.keyCode&&datasets>1?(selectLastDataset(),e.preventDefault()):83==e.keyCode?progress+=.2:66==e.keyCode?progress-=.2:70==e.keyCode&&(progress=1)}function onKeyPress(e){38==e.keyCode&&datasets>1?e.preventDefault():40==e.keyCode&&datasets>1&&e.preventDefault()}function onKeyUp(e){27==e.keyCode&&"search"==document.activeElement.id?(search.value="",onSearchChange()):38==e.keyCode&&datasets>1?e.preventDefault():40==e.keyCode&&datasets>1&&e.preventDefault()}function onSearchChange(){nSearchResults=0,head.search(),searchResults.innerHTML=""==search.value?"":nSearchResults+" results",setFocus(selectedNode),draw()}function post(e,t,a,i){var s=document.createElement("form"),n=document.createElement("input"),o=document.createElement("input");s.appendChild(n),s.appendChild(o),s.method="POST",s.action=e,void 0==i&&(s.target="_blank",i=window),n.type="hidden",n.name=t,n.value=a,o.type="hidden",o.name="dataset",o.value=currentDataset,i.document.body.appendChild(s),s.submit()}function prevDataset(){var e=currentDataset;do 0==e?e=datasets-1:e--;while(datasetDropDown.options[e].disabled);selectDataset(e)}function radiusDecrease(){.309>bufferFactor&&(bufferFactor+=.03,updateViewNeeded=!0)}function radiusIncrease(){bufferFactor>.041&&(bufferFactor-=.03,updateViewNeeded=!0)}function resetKeyOffset(){currentKey=1,keyMinTextLeft=centerX+gRadius+buffer-buffer/(keys+1)/2+fontSize/2,keyMinAngle=0}function rgbText(e,t,a){var i=["rgb(",Math.floor(e),",",Math.floor(t),",",Math.floor(a),")"];return i.join("")}function round(e){return e>=1||-1>=e?e.toFixed(0):e.toPrecision(1)}function roundedRectangle(e,t,a,i,s){2*s>a&&(s=a/2),2*s>i&&(s=i/2),context.beginPath(),context.arc(e+s,t+s,s,Math.PI,3*Math.PI/2,!1),context.lineTo(e+a-s,t),context.arc(e+a-s,t+s,s,3*Math.PI/2,2*Math.PI,!1),context.lineTo(e+a,t+i-s),context.arc(e+a-s,t+i-s,s,0,Math.PI/2,!1),context.lineTo(e+s,t+i),context.arc(e+s,t+i-s,s,Math.PI/2,Math.PI,!1),context.lineTo(e,t+s)}function passClick(e){mouseClick(e)}function searchResultString(e){var t=this.searchResults;return this.isSearchResult&&t--," - "+e+(e>1?" results":" result")}function setCallBacks(){canvas.onselectstart=function(){return!1},options.onselectstart=function(){return!1},document.onmousemove=mouseMove,window.onblur=focusLost,window.onmouseout=focusLost,document.onkeyup=onKeyUp,document.onkeydown=onKeyDown,canvas.onmousedown=mouseClick,document.onmouseup=mouseUp,keyControl.onclick=toggleKeys,collapseCheckBox=document.getElementById("collapse"),collapseCheckBox.checked=collapse,collapseCheckBox.onclick=handleResize,collapseCheckBox.onmousedown=suppressEvent,maxAbsoluteDepthText=document.getElementById("maxAbsoluteDepth"),maxAbsoluteDepthButtonDecrease=document.getElementById("maxAbsoluteDepthDecrease"),maxAbsoluteDepthButtonIncrease=document.getElementById("maxAbsoluteDepthIncrease"),maxAbsoluteDepthButtonDecrease.onclick=maxAbsoluteDepthDecrease,maxAbsoluteDepthButtonIncrease.onclick=maxAbsoluteDepthIncrease,maxAbsoluteDepthButtonDecrease.onmousedown=suppressEvent,maxAbsoluteDepthButtonIncrease.onmousedown=suppressEvent,fontSizeText=document.getElementById("fontSize"),fontSizeButtonDecrease=document.getElementById("fontSizeDecrease"),fontSizeButtonIncrease=document.getElementById("fontSizeIncrease"),fontSizeButtonDecrease.onclick=fontSizeDecrease,fontSizeButtonIncrease.onclick=fontSizeIncrease,fontSizeButtonDecrease.onmousedown=suppressEvent,fontSizeButtonIncrease.onmousedown=suppressEvent,radiusButtonDecrease=document.getElementById("radiusDecrease"),radiusButtonIncrease=document.getElementById("radiusIncrease"),radiusButtonDecrease.onclick=radiusDecrease,radiusButtonIncrease.onclick=radiusIncrease,radiusButtonDecrease.onmousedown=suppressEvent,radiusButtonIncrease.onmousedown=suppressEvent,maxAbsoluteDepth=0,backButton=document.getElementById("back"),backButton.onclick=navigateBack,backButton.onmousedown=suppressEvent,forwardButton=document.getElementById("forward"),forwardButton.onclick=navigateForward,forwardButton.onmousedown=suppressEvent,snapshotButton=document.getElementById("snapshot"),snapshotButton.onclick=snapshot,snapshotButton.onmousedown=suppressEvent,detailsName=document.getElementById("detailsName"),detailsExpand=document.getElementById("detailsExpand"),detailsInfo=document.getElementById("detailsInfo"),search=document.getElementById("search"),search.onkeyup=onSearchChange,search.onmousedown=suppressEvent,searchResults=document.getElementById("searchResults"),useHueDiv=document.getElementById("useHueDiv"),linkButton=document.getElementById("linkButton"),linkButton.onclick=showLink,linkButton.onmousedown=suppressEvent,linkText=document.getElementById("linkText"),linkText.onblur=hideLink,linkText.onmousedown=suppressEvent,hide(linkText);var e=document.getElementById("help");e.onmousedown=suppressEvent;var t=document.getElementById("searchClear");if(t.onmousedown=suppressEvent,datasets>1){datasetDropDown.onmousedown=suppressEvent;var a=document.getElementById("prevDataset");a.onmousedown=suppressEvent;var i=document.getElementById("nextDataset");i.onmousedown=suppressEvent;var s=document.getElementById("lastDataset");s.onmousedown=suppressEvent}image=document.getElementById("hiddenImage"),image.complete?hiddenPattern=context.createPattern(image,"repeat"):image.onload=function(){hiddenPattern=context.createPattern(image,"repeat")};var n=document.getElementById("loadingImage");n&&(loadingImage=n.src)}function selectDataset(e){lastDataset=currentDataset,currentDataset=e,datasets>1&&(datasetDropDown.selectedIndex=currentDataset,updateDatasetButtons(),datasetAlpha.start=1.5,datasetChanged=!0),head.setMagnitudes(0),head.setDepth(1,1),head.setMaxDepths(),handleResize()}function selectLastDataset(){selectDataset(lastDataset),handleResize()}function selectNode(e){selectedNode!=e&&(nodeHistory.length=nodeHistoryPosition,0!=selectedNode&&(nodeHistory.push(selectedNode),nodeHistoryPosition++),setSelectedNode(e)),updateDatasetButtons()}function setFocus(e){focusNode=e,detailsName.innerHTML=e.href?'<a target="_blank" href="'+e.href+'">'+e.name+"</a>":e.name;var t="<table>";t+="<tr><td></td></tr>";for(var a=0;a<e.attributes.length;a++)if(attributes[a].displayName&&void 0!=e.attributes[a]){var i=1==e.attributes[a].length&&attributes[a].mono?0:currentDataset;if("number"==typeof e.attributes[a][currentDataset]||void 0!=e.attributes[a][i]&&""!=e.attributes[a][currentDataset]){var s=e.attributes[a][i];void 0!=attributes[a].listNode?s='<a href="" onclick="showList('+attributeIndex(attributes[a].listNode)+","+a+',false);return false;" title="Show list">'+s+"</a>":void 0!=attributes[a].listAll?s='<a href="" onclick="showList('+attributeIndex(attributes[a].listAll)+","+a+',true);return false;" title="Show list">'+s+"</a>":void 0!=attributes[a].dataNode&&dataEnabled?s='<a href="" onclick="showData('+attributeIndex(attributes[a].dataNode)+","+a+',false);return false;" title="Show data">'+s+"</a>":void 0!=attributes[a].dataAll&&dataEnabled&&(s='<a href="" onclick="showData('+attributeIndex(attributes[a].dataAll)+","+a+',true);return false;" title="Show data">'+s+"</a>"),t+="<tr><td><strong>"+attributes[a].displayName+":</strong></td><td>"+s+"</td></tr>"}}t+="</table>",detailsInfo.innerHTML=t,detailsExpand.disabled=!focusNode.hasChildren()||focusNode==selectedNode}function setSelectedNode(e){zoomOut=selectedNode&&selectedNode.hasParent(e)?!0:!1,selectedNodeLast=selectedNode,selectedNode=e,setFocus(selectedNode)}function waitForData(e,t,a,i,s,n){if(nodeData.length==t){if(void 0!=s){for(var o=0;o<nodeData.length;o++)nodeData[o]=nodeData[o].replace(/\n/g,",");var r=nodeData.join("");r=r.slice(0,-1),e.document.body.removeChild(e.document.getElementById("loading")),document.body.removeChild(document.getElementById("data")),post(s,n,r,e)}else e.document.open(),e.document.write("<pre>"+nodeData.join("")+"</pre>"),e.document.close();e.document.title=a}else{var h=new Date;h.getTime()-i>1e4?(e.document.body.removeChild(e.document.getElementById("loading")),document.body.removeChild(document.getElementById("data")),e.document.body.innerHTML="Timed out loading supplemental files for:<br/>"+document.location):setTimeout(function(){waitForData(e,t,a,i,s,n)},100)}}function data(e){nodeData.push(e)}function enableData(){dataEnabled=!0}function showData(e,t,a){var i=window.open("","_blank"),s="Krona - "+attributes[t].displayName+" - "+focusNode.name;i.document.title=s,nodeData=new Array,i&&i.document&&null!=i.document.body&&(i.document.body.innerHTML='<img id="loading" src="'+loadingImage+'" alt="Loading..."></img>');var n=document.createElement("div");n.id="data",document.body.appendChild(n);for(var o=focusNode.getData(e,a),r=new Date,h=r.getTime(),d=0;d<o.length;d++){var l=document.createElement("script");l.src=o[d]+"?"+h,n.appendChild(l)}return waitForData(i,o.length,s,h,attributes[t].postUrl,attributes[t].postVar),!1}function showList(e,t,a){var i=focusNode.getList(e,a);if(void 0!=attributes[t].postUrl)post(attributes[t].postUrl,attributes[t].postVar,i.join(","));else{var s=window.open("","_blank");s.document.open(),s.document.write("<pre>"+i.join("\n")+"</pre>"),s.document.close(),s.document.title="Krona - "+attributes[t].displayName+" - "+focusNode.name}}function snapshot(){svg=svgHeader(),resetKeyOffset(),snapshotMode=!0,selectedNode.draw(!1,!0),selectedNode.draw(!0,!0),0!=focusNode&&focusNode!=selectedNode&&(context.globalAlpha=1,focusNode.drawHighlight(!0)),hueDisplayName&&useHue()&&drawLegendSVG(),snapshotMode=!1,svg+=svgFooter(),snapshotWindow=window.open("data:image/svg+xml;charset=utf-8,"+encodeURIComponent(svg),"_blank")}function save(){alert(document.body.innerHTML)}function spacer(){return snapshotMode?"&#160;&#160;&#160;":"   "}function suppressEvent(e){e.cancelBubble=!0,e.stopPropagation&&e.stopPropagation()}function svgFooter(){return"</svg>"}function svgHeader(){var e=.6*fontSize;return'<?xml version="1.0" standalone="no"?><!DOCTYPE svg PUBLIC "-//W3C//DTD SVG 1.1//EN" 	"http://www.w3.org/Graphics/SVG/1.1/DTD/svg11.dtd"><svg width="'+imageWidth+'" height="'+imageHeight+'" version="1.1"	xmlns="http://www.w3.org/2000/svg"><title>Krona (snapshot) - '+(datasets>1?datasetNames[currentDataset]+" - ":"")+selectedNode.name+'</title><defs>	<style type="text/css">	text {font-size: '+fontSize+"px; font-family: "+fontFamily+"; dominant-baseline:central}	path {stroke-width:"+thinLineWidth*fontSize/12+";}	path.wedge {stroke:none}	path.line {fill:none;stroke:black;}	line {stroke:black;stroke-width:"+thinLineWidth*fontSize/12+";}	line.tick {stroke-width:"+thinLineWidth*fontSize/6+";}	line.pattern {stroke-width:"+thinLineWidth*fontSize/18+";}	circle {fill:none;stroke:black;stroke-width:"+thinLineWidth*fontSize/12+";}	rect {stroke:black;stroke-width:"+thinLineWidth*fontSize/12+";}	.highlight {stroke:black;stroke-width:"+highlightLineWidth*fontSize/12+';}	.searchHighlight {fill:rgb(255, 255, 100);stroke:none;}	</style><pattern id="hiddenPattern" patternUnits="userSpaceOnUse" x="0" y="0" width="'+e+'" height="'+e+'"><line class="pattern" x1="0" y1="0" x2="'+e/2+'" y2="'+e/2+'"/><line class="pattern" x1="'+e/2+'" y1="'+e+'" x2="'+e+'" y2="'+e/2+'"/></pattern></defs>'
}function svgText(e,t,a,i,s,n){return"undefined"==typeof i&&(i="start"),void 0==n&&(n="black"),'<text x="'+t+'" y="'+a+'" style="font-color:'+n+";font-weight:"+(s?"bold":"normal")+'" text-anchor="'+i+'">'+e+"</text>"}function toggleKeys(){showKeys?(keyControl.value="…",showKeys=!1):(keyControl.value="x",showKeys=!0),updateKeyControl(),1==progress&&draw()}function update(){if(head){if(mouseDown&&focusNode!=selectedNode){var e=new Date;e.getTime()-mouseDownTime>quickLookHoldLength&&focusNode.hasChildren()&&(expand(focusNode),quickLook=!0)}updateViewNeeded&&(resize(),mouseX=-1,mouseY=-1,collapse=collapseCheckBox.checked,compress=!0,shorten=!0,checkSelectedCollapse(),updateMaxAbsoluteDepth(),setFocus(focusNode.getCollapse()||focusNode.depth>maxAbsoluteDepth?selectedNode:focusNode),updateView(),updateViewNeeded=!1);var e=new Date;progress=(e.getTime()-tweenStartTime)/tweenLength,progress>=1&&(progress=1),progress!=progressLast&&(tweenFactor=(1/(1+Math.exp(-tweenCurvature*(progress-.5)))-.5)/(tweenMax-.5)/2+.5,1==progress&&(snapshotButton.disabled=!1,zoomOut=!1,fpsDisplay&&(fpsDisplay.innerHTML="fps: "+Math.round(1e3*tweenFrames/tweenLength))),draw()),progressLast=progress}}function updateDatasetButtons(){if(1!=datasets){var e=selectedNode?selectedNode:head;datasetButtonLast.disabled=0==e.attributes[magnitudeIndex][lastDataset],datasetButtonPrev.disabled=!0,datasetButtonNext.disabled=!0;for(var t=0;datasets>t;t++){var a=0==e.attributes[magnitudeIndex][t];datasetDropDown.options[t].disabled=a,a||t!=currentDataset&&(datasetButtonPrev.disabled=!1,datasetButtonNext.disabled=!1)}}}function updateDatasetWidths(){if(datasets>1)for(var e=0;datasets>e;e++){context.font=fontBold;var t=context.measureText(datasetNames[e]);datasetWidths[e]=t.width}}function updateKeyControl(){0==keys?keyControl.style.visibility="hidden":(keyControl.style.visibility="visible",keyControl.style.right=margin+"px",keyControl.style.top=showKeys?imageHeight-(keys*(keySize+keyBuffer)-keyBuffer+margin+1.5*keyControl.clientHeight)+"px":imageHeight-margin-keyControl.clientHeight+"px")}function updateView(){selectedNode.depth>maxAbsoluteDepth-1&&(maxAbsoluteDepth=selectedNode.depth+1),highlightedNode=selectedNode,angleFactor=2*Math.PI/selectedNode.magnitude,maxPossibleDepth=Math.floor(gRadius/(fontSize*minRingWidthFactor)),4>maxPossibleDepth&&(maxPossibleDepth=4);var e=8*fontSize/gRadius,t=6*fontSize/gRadius,a=5*fontSize/gRadius;e>.25&&(e=.25),t>.15&&(t=.15),a>.15&&(a=.15);var i,s=selectedNode.getMaxDepth()-selectedNode.getDepth()+1;do{if(i=s,!compress&&i>maxPossibleDepth&&(i=maxPossibleDepth),compress){compressedRadii=new Array(i),compressedRadii[0]=e;for(var n=0;lerp(Math.atan(n+2),Math.atan(n+1),Math.atan(i+n-1),e,1-a)-e>t&&10>n;)n++;n--;for(var o=1;i>o;o++)compressedRadii[o]=lerp(Math.atan(o+n),Math.atan(n),Math.atan(i+n-1),e,1-a)}else nodeRadius=1/i;s=selectedNode.maxVisibleDepth(i),compress||s>maxPossibleDepth&&(s=maxPossibleDepth)}while(i>s);maxDisplayDepth=i,lightnessFactor=(lightnessMax-lightnessBase)/(i>8?8:i),keys=0,nLabelOffsets=new Array(maxDisplayDepth-1),labelOffsets=new Array(maxDisplayDepth-1),labelLastNodes=new Array(maxDisplayDepth-1),labelFirstNodes=new Array(maxDisplayDepth-1);for(var o=0;maxDisplayDepth-1>o;o++){if(compress)if(o==maxDisplayDepth-1)nLabelOffsets[o]=0;else{var r=(compressedRadii[o+1]-compressedRadii[o])*gRadius;nLabelOffsets[o]=Math.floor(r/fontSize/1.2),nLabelOffsets[o]>2&&(nLabelOffsets[o]=min(Math.floor(r/fontSize/1.75),5))}else nLabelOffsets[o]=Math.max(Math.floor(1.5*Math.sqrt(nodeRadius*gRadius/fontSize)),3);labelOffsets[o]=Math.floor((nLabelOffsets[o]-1)/2),labelLastNodes[o]=new Array(nLabelOffsets[o]+1),labelFirstNodes[o]=new Array(nLabelOffsets[o]+1);for(var h=0;h<=nLabelOffsets[o];h++)labelLastNodes[o][h]=0,labelFirstNodes[o][h]=0}fontSizeText.innerHTML=fontSize,fontNormal=fontSize+"px "+fontFamily,context.font=fontNormal,fontBold="bold "+fontSize+"px "+fontFamily,tickLength=.7*fontSize,head.setTargets(0),keySize=1*(imageHeight-3*margin)/2/keys*3/4,keySize>fontSize*maxKeySizeFactor&&(keySize=fontSize*maxKeySizeFactor),keyBuffer=keySize/3,fontSizeLast=fontSize,datasetChanged?datasetChanged=!1:datasetAlpha.start=0;var d=new Date;tweenStartTime=d.getTime(),progress=0,tweenFrames=0,updateKeyControl(),updateDatasetWidths(),document.title="Krona - "+selectedNode.name,updateNavigationButtons(),snapshotButton.disabled=!0,maxAbsoluteDepthText.innerHTML=maxAbsoluteDepth-1,maxAbsoluteDepthButtonDecrease.disabled=2==maxAbsoluteDepth,maxAbsoluteDepthButtonIncrease.disabled=maxAbsoluteDepth==head.maxDepth,collapse!=collapseLast&&""!=search.value&&(onSearchChange(),collapseLast=collapse)}function updateMaxAbsoluteDepth(){for(;selectedNode.depth>maxAbsoluteDepth-1;)selectedNode=selectedNode.getParent()}function updateNavigationButtons(){backButton.disabled=0==nodeHistoryPosition,forwardButton.disabled=nodeHistoryPosition==nodeHistory.length}function useHue(){return useHueCheckBox&&useHueCheckBox.checked}var canvas,context,svg,collapse=!0,collapseCheckBox,collapseLast,compress,compressCheckBox,maxAbsoluteDepthText,maxAbsoluteDepthButtonDecrease,maxAbsoluteDepthButtonIncrease,fontSize=11,fontSizeText,fontSizeButtonDecrease,fontSizeButtonIncrease,fontSizeLast,radiusButtonDecrease,radiusButtonIncrease,shorten,shortenCheckBox,maxAbsoluteDepth,backButton,upButton,forwardButton,snapshotButton,snapshotMode=!1,details,detailsName,search,searchResults,nSearchResults,useHueCheckBox,useHueDiv,datasetDropDown,datasetButtonLast,datasetButtonPrev,datasetButtonNext,keyControl,showKeys=!0,linkButton,linkText,frame,head,selectedNode=0,focusNode=0,highlightedNode=0,highlightingHidden=!1,nodes=new Array,currentNodeID=0,nodeHistory=new Array,nodeHistoryPosition=0,dataEnabled=!1,getVariables=new Array,selectedNodeLast=0,zoomOut=!1,quickLook=!1,mouseDown=!1,mouseDownTime,quickLookHoldLength=200,imageWidth,imageHeight,centerX,centerY,gRadius,updateViewNeeded=!1,rotationOffset=Math.PI/2,buffer,bufferFactor=.1,mapBuffer=10,mapRadius=0,maxMapRadius=25,mapWidth=150,maxLabelOverhang=4.18*Math.PI,maxKeySizeFactor=2,keySize,keys,keyBuffer=10,currentKey,keyMinTextLeft,keyMinAngle,minRingWidthFactor=5,maxPossibleDepth,maxDisplayDepth,headerHeight=0,historySpacingFactor=1.6,historyAlphaDelta=.25,lineOpacity=.3,saturation=.5,lightnessBase=.6,lightnessMax=.8,thinLineWidth=.3,highlightLineWidth=1.5,labelBoxBuffer=6,labelBoxRounding=15,labelWidthFudge=1.05,fontNormal,fontBold,fontFamily="sans-serif",nodeRadius,angleFactor,tickLength,compressedRadii,highlightFill="rgba(255, 255, 255, .3)",colorUnclassified="rgb(220,220,220)",labelOffsets,labelLastNodes,labelFirstNodes,nLabelOffsets=3,mouseX=-1,mouseY=-1,progress=0,progressLast=0,tweenFactor=0,tweenLength=850,tweenCurvature=13,tweenMax=1/(1+Math.exp(-tweenCurvature/2)),tweenStartTime,tweenFrames=0,fpsDisplay=document.getElementById("frameRate"),attributes=new Array,magnitudeIndex,membersAssignedIndex,membersSummaryIndex,hueDisplayName,hueStopPositions,hueStopHues,hueStopText,currentDataset=0,lastDataset=0,datasets=1,datasetNames,datasetSelectSize=30,datasetAlpha=new Tween(0,0),datasetWidths=new Array,datasetChanged,datasetSelectWidth=50;window.onload=load;var image,hiddenPattern,loadingImage,logoImage,options;
